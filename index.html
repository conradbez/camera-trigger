<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <title>Trigger Photo with Bluetooth Headphones</title>
</head>

<body>
    <main class="container">

    <header class="container">
            <h3>Remote Photo Trigger with Bluetooth Headphones</h3>
        </header>
            <section>
                    <details>
                        <summary>Need to take a photo without being right next to your phone?</summary>
                        <p >
                        <!-- class="instructions" -->
                            Quick and easy way to snap a photo hands free, <br>
                            using your wireless headphones
                        </p>
                      </details>

                    



                      <details>
                        <summary>How?</summary>
                        <p>
                            <ul role="listbox">
                                <li>Press "Start Camera" button below</li>
                                <li>Then press play/pause on your headphones to capture a photo</li>
                                <li>note: for Airpods, at least one needs to be in your ear</li>
                              </ul>
                        </p>
                      </details>
                <h2>Live Camera Preview</h2>
                <!-- <video id="livePreview" width="300" playsinline></video> try to fix preview not working on iPhone -->
                <article>
                    <video id="livePreview" width="100%" muted autoplay playsinline></video>
                </article>
                <button id="startFlipBtn">Start Camera</button>
                <button onclick="captureImage()">Take Photo</button>
                <div class="images-container" id="imagesContainer"></div>
            </section>
        
        <footer>
            <div
                style = "
                margin-top: 10px;
                /* height of the buy me a coffe button */
                height: 60px; 
                display: flex;
                flex-direction: row;
                gap: 10px;
                justify-content: space-between;
                align-items: center;
                "
            >

            <script type="text/javascript" src="https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js" data-name="bmc-button" data-slug="conradbez" data-color="#FFDD00" data-emoji=""  data-font="Cookie" data-text="Buy me a coffee" data-outline-color="#000000" data-font-color="#000000" data-coffee-color="#ffffff" ></script>
            <small>
                <a href="conradbez.com">conradbez.com</a>
            </small>

            </div>
            <div style="margin-top: 10px; text-align: center;">
                <small >
                    · created with help from GPT4 and Pico.css ·
                </small>
            </div>
            <br>
        </footer>
        </main>
        <script>

function generateSilentWAV(durationInSeconds) {
    const sampleRate = 44100; // Samples per second
    const byteRate = sampleRate * 2 * 2; // Sample rate * block align * bits per sample/8
    const blockAlign = 2 * 2; // Channels * bits per sample/8
    const numSamples = sampleRate * durationInSeconds;
    const dataByteCount = numSamples * 2 * 2; // numSamples * block align
    const buffer = new ArrayBuffer(44 + dataByteCount); // 44 bytes for header + data
    const view = new DataView(buffer);

    function writeString(view, offset, string) {
        for (let i = 0; i < string.length; i++) {
            view.setUint8(offset + i, string.charCodeAt(i));
        }
    }

    // RIFF identifier
    writeString(view, 0, 'RIFF');
    // File length minus RIFF identifier and size
    view.setUint32(4, 36 + dataByteCount, true);
    // RIFF type
    writeString(view, 8, 'WAVE');
    // Format chunk identifier
    writeString(view, 12, 'fmt ');
    // Format chunk length
    view.setUint32(16, 16, true);
    // Sample format
    view.setUint16(20, 1, true);
    // Channel count
    view.setUint16(22, 2, true);
    // Sample rate
    view.setUint32(24, sampleRate, true);
    // Byte rate
    view.setUint32(28, byteRate, true);
    // Block align
    view.setUint16(32, blockAlign, true);
    // Bits per sample
    view.setUint16(34, 16, true);
    // Data chunk identifier
    writeString(view, 36, 'data');
    // Data byte count
    view.setUint32(40, dataByteCount, true);

    // Create silent samples (0 data for PCM)
    for (let i = 44; i < buffer.byteLength; i += 2) {
        view.setInt16(i, 0, true);
    }

    return new Blob([view], { type: 'audio/wav' });
}

            const silentWAV = generateSilentWAV(3600); // 3600 seconds of silence
            const audioURL = URL.createObjectURL(silentWAV);
            const audioElement = document.createElement("audio");
            audioElement.src = audioURL

            document.body.appendChild(audioElement);
            const videoElement = document.getElementById("livePreview");
            const imagesContainer = document.getElementById("imagesContainer");
            const readyBtn = document.getElementById("readyBtn");
            const startFlipBtn = document.getElementById("startFlipBtn");
            let isFirstPlay = true;
            let useFrontCamera = true;
            function startCamera(front = true) {
                navigator.mediaDevices
                    .getUserMedia({ video: { facingMode: front ? "user" : "environment" } })
                    .then((stream) => {
                        videoElement.srcObject = stream;
                    })
                    .catch((error) => {
                        console.error("Error accessing the camera:", error);
                        alert("Error accessing the camera")
                    });
            }
            function captureImage() {
                const canvas = document.createElement("canvas");
                canvas.width = videoElement.videoWidth;
                canvas.height = videoElement.videoHeight;
                const ctx = canvas.getContext("2d");
                ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                const imageUrl = canvas.toDataURL("image/png");
                const imgElement = new Image();
                imgElement.src = imageUrl;
                imgElement.style = "width:100%"
                const downloadButton = document.createElement("button");
                console.log(downloadButton)
                const downloadLink = document.createElement("a")
                downloadLink.href = imageUrl;
                downloadLink.download = "captured_image.png";
                downloadLink.innerText = "Download";
                const imageItem = document.createElement("article");
                imageItem.appendChild(imgElement);
                imageItem.appendChild(downloadLink);
                imagesContainer.appendChild(imageItem);
            }
            audioElement.addEventListener("play", function () {
                if (!isFirstPlay) {
                    console.log("Audio started playing");
                    captureImage();
                } else {
                    isFirstPlay = false;
                }
            });
            audioElement.addEventListener("pause", function () {
                console.log("Audio paused");
                captureImage();
            });
            // startCamera();
            startFlipBtn.addEventListener("click", function () {
                useFrontCamera = !useFrontCamera;
                startCamera(useFrontCamera);
                if (
                    //this indicates we are on the first run and need to start the audio
                    startFlipBtn.innerText == "Start Camera"
                ) {
                    audioElement.play();
                    // audioElement.muted = true; // seems to break everything for some reason
                }
                startFlipBtn.innerText = "Flip"
            });


        </script>
        <audio
            src="https://commondatastorage.googleapis.com/codeskulptor-demos/DDR_assets/Kangaroo_MusiQue_-_The_Neverwritten_Role_Playing_Game.mp3"></audio>

</body>