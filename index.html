<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <title>Photo with Bluetooth Headphones</title>
</head>

<body>
    <header class="container">
    <header>
        <h1>Photo with Bluetooth Headphones</h1>
    </header>
    <main class="container">
        <section>
            Turn your phone media audio low
            then press "Ready"
            <button id="readyBtn" class="ready-btn">Ready</button>
            <p class="instructions">Now press play/pause on your headphones to capture a photo (note: for Airpods, at least
                one Airpod needs to be in your ear).</p>
            <h2>Live Camera Preview</h2>
            <!-- <video id="livePreview" width="300" playsinline></video> try to fix preview not working on iPhone -->
            <video id="livePreview" width="300" autoplay=""></video>
            <button id="flipBtn" class="flip-btn">Flip Camera</button>
            <div class="images-container" id="imagesContainer"></div>
        </section>
    </main>
    <footer>
        <p>Created with help of GPT4 and the Pico.css framework</p>
    </footer>
    <script>
        const audioElement = document.createElement("audio");
        audioElement.src =
            "https://commondatastorage.googleapis.com/codeskulptor-demos/DDR_assets/Kangaroo_MusiQue_-_The_Neverwritten_Role_Playing_Game.mp3";
        document.body.appendChild(audioElement);
        const videoElement = document.getElementById("livePreview");
        const imagesContainer = document.getElementById("imagesContainer");
        const readyBtn = document.getElementById("readyBtn");
        const flipBtn = document.getElementById("flipBtn");
        let isFirstPlay = true;
        let useFrontCamera = true;
        function startCamera(front = true) {
            navigator.mediaDevices
                .getUserMedia({ video: { facingMode: front ? "user" : "environment" } })
                .then((stream) => {
                    videoElement.srcObject = stream;
                })
                .catch((error) => {
                    console.error("Error accessing the camera:", error);
                });
        }
        function captureImage() {
            const canvas = document.createElement("canvas");
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
            const imageUrl = canvas.toDataURL("image/png");
            const imgElement = new Image();
            imgElement.src = imageUrl;
            const downloadLink = document.createElement("a");
            downloadLink.href = imageUrl;
            downloadLink.download = "captured_image.png";
            downloadLink.innerText = "Download";
            downloadLink.className = "download-btn";
            const imageItem = document.createElement("div");
            imageItem.className = "image-item";
            imageItem.appendChild(imgElement);
            imageItem.appendChild(downloadLink);
            imagesContainer.appendChild(imageItem);
        }
        audioElement.addEventListener("play", function () {
            if (!isFirstPlay) {
                console.log("Audio started playing");
                captureImage();
            } else {
                isFirstPlay = false;
            }
        });
        audioElement.addEventListener("pause", function () {
            console.log("Audio paused");
            captureImage();
        });
        startCamera();
        flipBtn.addEventListener("click", function () {
            useFrontCamera = !useFrontCamera;
            startCamera(useFrontCamera);
        });
        readyBtn.addEventListener("click", function () {
            audioElement.play();
        });
        readyBtn.addEventListener("click", function () {
            // audioElement.muted = true; // seems to break everything for some reason
            // console.log(audioElement)
        });

    </script>
    <audio
        src="https://commondatastorage.googleapis.com/codeskulptor-demos/DDR_assets/Kangaroo_MusiQue_-_The_Neverwritten_Role_Playing_Game.mp3"></audio>

</body>